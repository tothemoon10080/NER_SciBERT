Train-based systems are the principal means of public transportation in many of the world's cities, and continue to grow in the face of rising demand. Expanding infrastructure is costly, however, and at a certain point becomes unsustainable. When this occurs the only feasible solution is to improve the management system. This can be done using on line approaches, such as pre-programming schedules that use historic information, or online approaches that employ system status information obtained during operation. In this paper the metro system is partitioned into sub-systems each of them associated to an agent based predictive controller in charge of local optimization. Each controller has its own state estimator that gives online information of the subsystem. By means of communication between agents the optimization of the whole metro system is achieved. The reduction in waiting times can be greater than 20%, depending on the ridership of the line.